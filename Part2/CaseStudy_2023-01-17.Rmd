---
title: 'Case Study: How Does Drought Impact Wind Erosion Risk?'
author: "Sarah McCord, Eric Jensen"
date: "2023-11-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Overview

Now we will use all of the skills we have learned in this workshop in a real world case study. This example walks through using R and publicly available datasets to examine how drought is influencing wind erosion in the Chihuahuan Desert. Our goal is to reproduce Figure 4 from McCord et al. 2024 (***https://doi.org/10.1002/ael2.20120***). First, we will query the Landscape Data Commons for data that fall within the Chihuahuan Desert ecoregion. Then, we will use these data to set a benchmark of expected wind erosion risk in the Chihuahuan Desert. With this benchmark in place, we will apply it to the monitoring data in the Landscape Data Commons and compare those results at multiple spatial scales. Finally, we will incorporate drought and remote-sensing based fractional cover data (***FOR ERIC, Bare ground from RAP could be cool here***), to provide additional context to the field based monitoring data.

![](images/figure_4.jpg)
Library the packages we will use in this demo
```{r}
library(trex) # for fulling data on the Landscape Data Commons
library(sf) 
library(ggplot2) # for data visualization
library(viridis) # colorblind friendly color palettes
```

## 1. Prepare Data
Make sure your working directory is set for Part2 of this workshop, for example: setwd("C:/Users/gharrison/OneDrive - USDA/Documents/R scripts/RinRange_workshop_srm24/Part2")

Now we need to pull in some polygons for our region of interest so that we can set a spatial boundaries on our data.  
*GH will come back and change the fetch edit command so that these data are already downloaded*
*It'd be nice to leave it in, but perhaps commented out?*
```{r}
# get polygons
chihuahuan_desert <- read_sf("MapLayers/ChihuahuanDesert.shp")
sandy_esg <- read_sf("MapLayers/SandyESG.shp")

# extract data from LDC
data <- fetch_ldc_spatial(chihuahuan_desert,
                          data_type = "indicators")

head(data)

# Let's do a bit of clean up and make sure the data fields are formatted properly
data <- data |> dplyr::mutate(DateVisited = lubridate::as_date(DateVisited),
                                    Year = lubridate::year(DateVisited) |> as.factor())


# Make sure the Lat/Long coordinates are numeric
data <- data |> 
  dplyr::mutate(Longitude_NAD83 = as.numeric(Longitude_NAD83),
                Latitude_NAD83 = as.numeric(Latitude_NAD83)) 

```

## 2. Establish benchmark
We want to understand which sites might be susceptible to wind erosion. To do this, we took a subset (~600) of the points in the ecoregion and compared them with wind erosion models and determined that decreases in total foliar cover below 30% are associated with an increase in wind erosion risk. However, we do not want to apply the benchmark to the points used to develop the benchmark. So we will first remove the benchmark generation points. Then we will apply the 30% benchmark to these points. 
``` {r}
# get benchmark developmentdata
benchmark <- read.csv("benchmark_points.csv")

head(benchmark)
```

## 3. Apply benchmark
``` {r}
# remove data that have been used in benchmarking
# check total number of plots
nrow(data)
data <- data |> subset(!PrimaryKey %in% benchmark$PrimaryKey)
nrow(data)

# Apply the benchmark of 30% to the Total Foliar Cover values
data <- data |> dplyr::mutate(evaluated = dplyr::case_when(TotalFoliarCover >30 ~ "Meeting",
                                                           TotalFoliarCover <=30 ~ "Not meeting"
))

# convert to spatial
# move from a st to sf object
# users must specify the columns which are coordinates, and the Coordinate reference system
## TO DO Georgia come back and add links for CRS
data_sf <- sf::st_as_sf(data %>% subset(!is.na(Longitude_NAD83)),
                     coords = c("Longitude_NAD83", "Latitude_NAD83"),
                     crs = st_crs(chihuahuan_desert))
# save these data as a shapefile
sf::st_write(data_sf, "ldc_data.shp", append=F) 


```


For management purposes, we are going to focus on the NM portion of the Chihuahuan Desert and the Sandy Ecological Site Group within that area.
``` {r}
# Subset the data to points found in New Mexico
nm_data <- data_sf |> subset(State == "NM")

# Identify the plots that are found in the Sandy ESG. Load in a table identifying all the SandyESG plots
sandy_plots <- read.csv("SandyESG_plots.csv")

# Join this back to the nm_data
nm_data <- dplyr::left_join(nm_data, 
                            sandy_plots, 
                            by = "PrimaryKey")

#TODO: Georgia we could also do this intersection in R if you want. In ArcGIS we intersected the Sandy Ecological Site group with our data. You can do this  Nelson, could you help me make this intersection work? I think I moved to R because it wasn't going well in R


# Identify the membership of each plot within different polygons (Chihuahuan Desert, MLRA 42, SandyESG and a long-term research site at the Jornada Experimental Range called "NWERN_JER")
nm_data <- nm_data |> dplyr::mutate(Chihuahuan_desert = "yes",
                                    MLRA42 = dplyr::case_when(mlrarsym %in% "42"~ "yes"),
                                    NWERN_JER = dplyr::case_when(ProjectKey %in% "NWERN_JER"~ "yes"))

# To faciliate plotting, it would be helpful if the data were long rather than wide.
nm_data_long <- as.data.frame(nm_data) |>
  tidyr::pivot_longer(cols = c("MLRA42",
                               "SandyESG", 
                               "NWERN_JER", 
                               "Chihuahuan_desert"),
                      names_to = "region",
                      values_to = "region_membership") |>
  subset(region_membership =="yes")|>
  dplyr::mutate(region = factor(region)|>
                  dplyr::recode( "NWERN_JER" = "Site",
                                 "SandyESG" = "ESG", 
                                 "MLRA42" = "MLRA",
                                 "Chihuahuan_desert" = "Ecoregion"))

# We also need region to be a factor for easier plot formatting
nm_data_long$region <- factor(nm_data_long$region,
                              levels = c( "Site", 
                                          "ESG",
                                          "MLRA",
                                          "Ecoregion")
                              )
```

### Plot the results

``` {r}
# box plot
ggplot(nm_data_long |> subset(Year %in% c("2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022") &
                                TotalFoliarCover),
       aes(x = Year,
           y = TotalFoliarCover,
           group = Year)) +
  facet_grid(rows = "region")+
  geom_boxplot()+
  geom_point(aes(color = evaluated))+
  scale_color_manual(values = c("darkblue", "orange"))+
  theme_bw()+
  ylab("Total foliar cover (%)")+
  guides(color=guide_legend(title="Benchmark status"))

# bar chart
ggplot(nm_data_long |> subset(Year %in% c("2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022") &
                                TotalFoliarCover),
       aes(x = Year,
           y = TotalFoliarCover,
           fill = evaluated)) +
  facet_grid(rows = "region")+
  geom_bar(position = "fill", stat = "identity")+
  scale_fill_manual(values = c("darkblue", "orange"))+
  theme_bw()+
  ylab("Proportion of plots")+
  guides(fill=guide_legend(title="Benchmark status"))

# summarize
nm_data_summary <- nm_data_long |> subset(
                         Year %in% c("2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022") &
                         TotalFoliarCover) |>
  dplyr::select(PrimaryKey, region, Year) |>
  dplyr::mutate(Year = as.character(Year)) |>
  dplyr::distinct()|>
  dplyr::group_by(Year, region) |> dplyr::tally()
```

## 4. Climate Data/RAP

